<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Comrpession test</title>
    <link href="https://cdnjs.cloudflare.com/ajax/libs/bootstrap/5.3.0/css/bootstrap.min.css" rel="stylesheet">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/gsap/3.12.2/gsap.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/paho-mqtt/1.0.1/mqttws31.min.js"></script>
</head>

<body>
    <script src="../ext/lzutf8.js"></script>
    <script src="../core/Throw.js"></script>
    <script src="../core/MqttClient.js"></script>
    <script>
        const client = new MQTTClient("192.168.10.25", 8083);

        let zones = ["DB", "B"];
        for (let i = 1; i <= 20; i++) {
            zones.push(`S${i}IN`, `D${i}`, `S${i}OUT`, `T${i}`);
        }

        const history = [];
        
        for(let i=0;i<1000;i++) {
            const th = new Throw(Math.random() * 360, Math.random() * 1.3, zones[Math.floor(Math.random() * zones.length)]);
            th.player = Math.floor(Math.random() * 4)
            th.dart = Math.floor(Math.random() * 3)
            th.round = Math.floor(Math.random() * 30)
            history.push(th);
        }

        function compress(obj) {
            const str = JSON.stringify(obj);
            console.log(str.length);


            var stringToCompress = str;
            var stringLengthAsUTF8 = LZUTF8.encodeUTF8(stringToCompress).length;

            //
            // Compression
            var timer = new LZUTF8.Timer();
            //
            var compressedBytes = LZUTF8.compress(stringToCompress);
            //
            var compressionTime = timer.getElapsedTime();
            var megabytesPerSecond = (stringLengthAsUTF8 / 1000000) / (compressionTime / 1000);
            var compressionRatioPercentage = compressedBytes.length / stringLengthAsUTF8 * 100;

            console.log("Compressed " + stringLengthAsUTF8 + " to " + compressedBytes.length + " bytes (" + compressionRatioPercentage.toFixed(1) + "%) in " + compressionTime.toFixed(1) + "ms (" + megabytesPerSecond.toFixed(1) + "MB/s)");
            //var compressedBytesAsDecimalString = LZUTF8Encoding.DecimalString.encode(compressedBytes);
            return compressedBytes;
        }
        //console.log(compressedBytesAsDecimalString);

        function decompress(compressedBytes) {
            //
            // Decompression
            var timer = new LZUTF8.Timer();
            //
            var decompressedString = LZUTF8.decompress(compressedBytes);
            //
            var decompressionTime = timer.getElapsedTime();

            console.log("Decompressed " + compressedBytes.length + " to " + decompressedString.length + " bytes (  in " + decompressionTime.toFixed(1) + "ms)");
            return JSON.parse(decompressedString);
        }

        const compressed = compress(history);


        client.subscribe("dartnet/history", (message, topic) => {
                console.log("MQTT: ", message)
                
                let utf8Encode = new TextEncoder();
                const bytesArray = utf8Encode.encode(message);
                const decompressed = decompress(bytesArray);
                console.log(decompressed)

            })

        let utf8Decoder = new TextDecoder();
        client.publish("dartnet/history", utf8Decoder.decode(compressed))
        
        
        //client.publish("dartnet/history",compressed)
        

   </script>
</body>

</html>
