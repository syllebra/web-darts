<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Zoomable Video Canvas</title>
    <link href="https://cdnjs.cloudflare.com/ajax/libs/bootstrap/5.3.0/css/bootstrap.min.css" rel="stylesheet">
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" rel="stylesheet">
    <script crossorigin="anonymous"
        src="https://cdnjs.cloudflare.com/ajax/libs/paho-mqtt/1.0.1/mqttws31.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/gsap/3.12.2/gsap.min.js"></script>
    <style>
        body,
        html {
            margin: 0;
            padding: 0;
            height: 100vh;
            overflow: hidden;
            background: linear-gradient(135deg, #1e3c72 0%, #2a5298 100%);
        }
    </style>
</head>

<body>
    <!-- Main Canvas-->
</body>
<script src="../core/global.js"></script>
<script src="../core/Throw.js"></script>
<script src="../core/MqttClient.js"></script>
<script src="../ui/ZoomablePannableCanvas.js"></script>
<script src="../ui/DartboardRenderer.js"></script>
<script src="../ui/DartboardLayer.js"></script>
<script>
    const dartboardLayer = new DartboardLayer(document.body);

    let zones = ["DB","B"];
    for(let i=1;i<=20;i++) {
        zones.push(`S${i}IN`, `D${i}`,`S${i}OUT`,`T${i}`);
    }

    let lights = {}

    function test(v) {
        if(v.opacity > 0.0)
            dartboardLayer.dartboardRenderer.enlightZone(v.zone,false, `rgba(0,255,255,${v.opacity*0.95})`, glowColor = `rgba(0,255,255,${v.opacity})`,1.5);
    }
    
    zones.forEach((z) =>  {
        const obj = {zone: z, opacity:0.0};
        lights[z] = obj;
        dartboardLayer.dartboardRenderer.extraRenderingFunctions.push( () => test(obj));
    })


    function flickZone(zone) {
        gsap.to(lights[zone], {
            opacity:1.0,
            repeat:11,
            yoyo: true,
            duration:0.08,
            ease:"power2.inout"
        }).then(()=> {lights[zone].opacity = 0;})
    }

    dartboardLayer.zoomableCanvas.setOnElementDragEnd((id, element, worldCoords) => {
      if (id == "Dartboard") {
        let thr = element.dbr.getThrowFromClick(worldCoords.x, worldCoords.y);
        console.log(thr)
        // Immediately publish - gets queued if not connected yet
          mqtt.publish('dartnet/hit', thr);
          console.log(mqtt.messageQueue)

        flickZone(thr.zone);
      }
    });

    const mqtt = new MQTTClient('192.168.31.120', 8083, {
        clientId: "Dartboard_test_"+location.origin,
        username: 'user',
        password: 'pass',
        onConnected: () => console.log('Connected!'),
        onDisconnected: () => console.log('Disconnected!'),
        onError: (err) => console.error('Error:', err)
    });

    // Immediately subscribe - connection happens automatically
    mqtt.subscribe('dartnet/hit', (data, topic) => {
        console.log(`${topic}:`, data, data.value);
    });

    // Immediately publish - gets queued if not connected yet
    mqtt.publish('dartnet/hit', {
        temperature: 23.5,
        humidity: 60
    });
    
</script>