<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Dart Impact Detection System</title>
    <link href="https://cdnjs.cloudflare.com/ajax/libs/bootstrap/5.3.0/css/bootstrap.min.css" rel="stylesheet">
    <style>
        .video-container {
            position: relative;
            display: inline-block;
        }

        .detection-overlay {
            position: absolute;
            top: 0;
            left: 0;
            pointer-events: none;
            border: 2px solid red;
            opacity: 0;
            transition: opacity 0.3s;
        }

        .detection-overlay.active {
            opacity: 1;
        }

        canvas {
            border: 1px solid #ddd;
            margin: 5px;
        }

        .status-indicator {
            width: 20px;
            height: 20px;
            border-radius: 50%;
            display: inline-block;
            margin-right: 10px;
        }

        .status-detecting {
            background-color: #28a745;
        }

        .status-paused {
            background-color: #6c757d;
        }

        .status-detected {
            background-color: #dc3545;
        }
    </style>
</head>

<body>
    <div class="container mt-4">
        <h1 class="mb-4">Dart Impact Detection System</h1>

        <div class="row">
            <div class="col-md-8">
                <div class="card">
                    <div class="card-body">
                        <h5 class="card-title">Video Stream</h5>
                        <div class="video-container">
                            <video id="webcam" width="640" height="480" autoplay muted></video>
                            <div id="detectionOverlay" class="detection-overlay"></div>
                        </div>
                        <div class="mt-3">
                            <div class="mb-3">
                                <label class="form-label">Video Source:</label>
                                <div class="btn-group" role="group">
                                    <input type="radio" class="btn-check" name="videoSource" id="webcamSource" checked>
                                    <label class="btn btn-outline-primary" for="webcamSource">Webcam</label>

                                    <input type="radio" class="btn-check" name="videoSource" id="fileSource">
                                    <label class="btn btn-outline-primary" for="fileSource">Video File</label>
                                </div>
                            </div>

                            <div id="fileInputContainer" style="display: none;" class="mb-3">
                                <input type="file" class="form-control" id="videoFileInput" accept="video/*">
                            </div>

                            <button id="startBtn" class="btn btn-success">Start Detection</button>
                            <button id="stopBtn" class="btn btn-danger" disabled>Stop Detection</button>
                            <button id="pauseBtn" class="btn btn-warning" disabled>Pause</button>
                        </div>
                    </div>
                </div>
            </div>

            <div class="col-md-4">
                <div class="card">
                    <div class="card-body">
                        <h5 class="card-title">Status</h5>
                        <p>
                            <span id="statusIndicator" class="status-indicator status-paused"></span>
                            <span id="statusText">Stopped</span>
                        </p>
                        <p><strong>Video Source:</strong> <span id="videoSource">None</span></p>
                        <p><strong>Detections:</strong> <span id="detectionCount">0</span></p>
                        <p><strong>Last Detection:</strong> <span id="lastDetection">Never</span></p>
                    </div>
                </div>

                <div class="card mt-3">
                    <div class="card-body">
                        <h5 class="card-title">Settings</h5>
                        <div class="mb-3">
                            <label for="temporalFilter" class="form-label">Temporal Filter (ms):</label>
                            <input type="range" class="form-range" id="temporalFilter" min="0" max="1000" value="200">
                            <span id="temporalFilterValue">200</span>
                        </div>
                        <div class="mb-3">
                            <label for="minMovement" class="form-label">Min Movement (%):</label>
                            <input type="range" class="form-range" id="minMovement" min="0.1" max="5" step="0.1"
                                value="0.4">
                            <span id="minMovementValue">0.4</span>
                        </div>
                        <div class="mb-3">
                            <label for="maxMovement" class="form-label">Max Movement (%):</label>
                            <input type="range" class="form-range" id="maxMovement" min="5" max="20" step="0.1"
                                value="10">
                            <span id="maxMovementValue">10</span>
                        </div>
                        <div class="mb-3">
                            <label for="threshold" class="form-label">Difference Threshold:</label>
                            <input type="range" class="form-range" id="threshold" min="4" max="100" value="10.2">
                            <span id="thresholdValue">10.2</span>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <div class="row mt-4">
            <div class="col-12">
                <div class="card">
                    <div class="card-body">
                        <h5 class="card-title">Debug Views</h5>
                        <div class="row">
                            <div class="col-md-4">
                                <h6>Current Difference</h6>
                                <canvas id="diffCanvas" width="320" height="240"></canvas>
                            </div>
                            <div class="col-md-4">
                                <h6>Delta (Movement)</h6>
                                <canvas id="deltaCanvas" width="320" height="240"></canvas>
                            </div>
                            <div class="col-md-4">
                                <h6>Detection Log</h6>
                                <div id="logOutput"
                                    style="height: 240px; overflow-y: scroll; background-color: #f8f9fa; padding: 10px; font-family: monospace; font-size: 12px;">
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script src="https://cdnjs.cloudflare.com/ajax/libs/bootstrap/5.3.0/js/bootstrap.bundle.min.js"></script>
    <script src="../../core/DartDetectors.js"></script>

    <script>
        // Global variables
        let detector = null;
        let video = null;
        let stream = null;
        let isRunning = false;
        let animationId = null;
        let isUsingFile = false;
        let videoFile = null;
        var snd2 = new Audio("data:audio/mpeg;base64,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wZ0G7jqlt/OcDIKX+/1NblSX+VKfQfP8xuJJGk7////rf////+PgXTv///1JThJJQainmySAB6imUyuVbVttUo7T4Csa821OuF88f62+CZHFnGf///mQgYIEO0SMF2NVy9NxYTdlqJ8AuS4zr//SJoTUJ+CaKKTcZvosrUPo8W/MUv0f033E9E/QpN6P///v/////WRR2mwUAYUABjabRu1vrOLKAF0kIdHjnEx/iNWo7jGn1////mApxNTJQQOU1Het/NoUFTMQs6Vja///THaGIl/0fojl8mjd/Jo8W+ZfpNpCajsz7////6kn/////WRRgDz//LD1KSTDjKOciSAKxdLx5S31uYqKIWj/+5JECgAC8V5M6g9rdFyr6Vo9rW6KtHcr5DEJQRkSpLRklSigvVc4QpmyPe9H3zHR1/in9P/8VNCMJOzYUDyVjfwHP0ZgiZt/3/+9EBnDKbegdUrckhgntHaQ9vX/X/9A/////+r/////mJ3/9ItRcoVRogAcmV9N8z0pvES8QQsKoMGXEymPQyWm6E4HQLqgpv/CZJAtYXQSwoF8e6SB56zABEoW+qgZjJAZovGr0Gl5/OjFKL3JwnaX9v7/X8y1f/////////49WAzMzEYYMZLq6CUANIqbDX7lisBIdraAEPwShTRc9WZ2vAqBc4NQ9GrUNaw0Czcrte0g1NEoiU8NFjx4NFh54FSwlOlgaCp0S3hqo8SLOh3/63f7P/KgKJxxhgGSnAFMCnIogwU5JoqBIDAuBIiNLETyFmiImtYiDTSlb8ziIFYSFv/QPC38zyxEOuPeVGHQ77r/1u/+kq49//6g4gjoVQSUMYQUSAP8PwRcZIyh2kCI2OwkZICZmaZxgnsNY8DmSCWX0idhtz3VTJSqErTSB//1X7TTTVVV//uSZB2P8xwRJ4HvYcItQlWBACM4AAABpAAAACAAADSAAAAEVf/+qCE000VVVVU0002//+qqqqummmmr///qqqppppoqqqqppppoqqATkEjIyIxBlBA5KwUEDBBwkFhYWFhUVFfiqhYWFhcVFRUVFv/Ff/xUVFRYWFpMQU1FMy45OS41qqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqg==");  
        let processingCanvas = document.createElement("canvas");
        let processingCtx = processingCanvas.getContext("2d", { willReadFrequently: true });

        function initializeApp() {
            detector = new DeltaVideoOnlyDartDetector();
            video = document.getElementById('webcam');

            // Setup detection callback
            detector.onDetectionCallback = (delta, percentage) => {
                showDetectionIndicator();
                updateDetectionStats();
                detector.log(`DART DETECTED! Movement: ${percentage.toFixed(1)}%`);
                snd2.play();
            };

            // Setup event listeners
            document.getElementById('startBtn').addEventListener('click', startDetection);
            document.getElementById('stopBtn').addEventListener('click', stopDetection);
            document.getElementById('pauseBtn').addEventListener('click', togglePause);

            // Setup video source selection
            document.getElementById('webcamSource').addEventListener('change', onVideoSourceChange);
            document.getElementById('fileSource').addEventListener('change', onVideoSourceChange);
            document.getElementById('videoFileInput').addEventListener('change', onVideoFileSelected);

            // Setup settings sliders
            setupSlider('temporalFilter', 'temporalFilterValue', updateSettings);
            setupSlider('minMovement', 'minMovementValue', updateSettings);
            setupSlider('maxMovement', 'maxMovementValue', updateSettings);
            setupSlider('threshold', 'thresholdValue', updateSettings);

            updateStatus('Stopped', 'status-paused');
            updateVideoSource();
        }

        function onVideoSourceChange() {
            const isFile = document.getElementById('fileSource').checked;
            const fileContainer = document.getElementById('fileInputContainer');

            if (isFile) {
                fileContainer.style.display = 'block';
                isUsingFile = true;
            } else {
                fileContainer.style.display = 'none';
                isUsingFile = false;
                videoFile = null;
            }

            updateVideoSource();

            // Stop current detection if running
            if (isRunning) {
                stopDetection();
            }
        }

        function onVideoFileSelected(event) {
            const file = event.target.files[0];
            if (file) {
                videoFile = file;
                updateVideoSource();
            }
        }

        function updateVideoSource() {
            const sourceSpan = document.getElementById('videoSource');
            if (isUsingFile) {
                if (videoFile) {
                    sourceSpan.textContent = `File: ${videoFile.name}`;
                } else {
                    sourceSpan.textContent = 'File: Not selected';
                }
            } else {
                sourceSpan.textContent = 'Webcam';
            }
        }

        function setupSlider(sliderId, valueId, callback) {
            const slider = document.getElementById(sliderId);
            const valueSpan = document.getElementById(valueId);

            slider.addEventListener('input', (e) => {
                valueSpan.textContent = e.target.value;
                callback();
            });
        }

        function updateSettings() {
            if (detector) {
                const temporalFilter = parseInt(document.getElementById('temporalFilter').value);
                const minMovement = parseFloat(document.getElementById('minMovement').value);
                const maxMovement = parseFloat(document.getElementById('maxMovement').value);
                const threshold = parseInt(document.getElementById('threshold').value);

                detector.updateSettings(temporalFilter, minMovement, maxMovement, threshold);
            }
        }

        async function startDetection() {
            try {
                if (isUsingFile) {
                    await startFileDetection();
                } else {
                    await startWebcamDetection();
                }

                isRunning = true;
                detector.onPause(); // Reset detector state

                document.getElementById('startBtn').disabled = true;
                document.getElementById('stopBtn').disabled = false;
                document.getElementById('pauseBtn').disabled = false;

                updateStatus('Detecting', 'status-detecting');
                processFrame();

            } catch (err) {
                console.error('Error starting detection:', err);
                alert('Error starting detection: ' + err.message);
            }
        }

        async function startWebcamDetection() {
            stream = await navigator.mediaDevices.getUserMedia({ video: true });
            video.srcObject = stream;
            await video.play();
        }

        async function startFileDetection() {
            if (!videoFile) {
                throw new Error('No video file selected');
            }

            const url = URL.createObjectURL(videoFile);
            video.src = url;
            video.loop = true;
            await video.play();
        }

        function stopDetection() {
            isRunning = false;

            if (animationId) {
                cancelAnimationFrame(animationId);
                animationId = null;
            }

            if (stream) {
                stream.getTracks().forEach(track => track.stop());
                stream = null;
            }

            if (video.src && video.src.startsWith('blob:')) {
                URL.revokeObjectURL(video.src);
            }

            video.srcObject = null;
            video.src = '';

            document.getElementById('startBtn').disabled = false;
            document.getElementById('stopBtn').disabled = true;
            document.getElementById('pauseBtn').disabled = true;

            updateStatus('Stopped', 'status-paused');

            // Clear canvases
            clearCanvas('diffCanvas');
            clearCanvas('deltaCanvas');
        }

        function togglePause() {
            detector.pauseDetection = !detector.pauseDetection;
            const btn = document.getElementById('pauseBtn');

            if (detector.pauseDetection) {
                btn.textContent = 'Resume';
                btn.className = 'btn btn-success';
                updateStatus('Paused', 'status-paused');
                detector.onPause();
            } else {
                btn.textContent = 'Pause';
                btn.className = 'btn btn-warning';
                updateStatus('Detecting', 'status-detecting');
            }
        }

        function processFrame() {
            if (!isRunning) return;

            if (!detector.pauseDetection && video.readyState === video.HAVE_ENOUGH_DATA) {
                try {
                    
                    let maxD = Math.max(video.videoWidth, video.videoHeight);
                    let W = Math.floor((video.videoWidth * 640) / maxD);
                    let H = Math.floor((video.videoHeight * 640) / maxD);
                    // console.log("Source:", video.videoWidth, video.videoHeight);
                    // console.log("Processing:", W, H);

                    // Set canvas size to match video
                    processingCanvas.width = W;
                    processingCanvas.height = H;

                    // Draw current frame to canvas
                    processingCtx.drawImage(video, 0, 0, processingCanvas.width, processingCanvas.height);
                    const imageData = processingCtx.getImageData(0, 0, processingCanvas.width, processingCanvas.height);


                    detector.onNewFrame(imageData);
                } catch (err) {
                    console.error('Error processing frame:', err);
                }
            }

            animationId = requestAnimationFrame(processFrame);
        }

        function updateStatus(text, className) {
            document.getElementById('statusText').textContent = text;
            const indicator = document.getElementById('statusIndicator');
            indicator.className = `status-indicator ${className}`;
        }

        function updateDetectionStats() {
            document.getElementById('detectionCount').textContent = detector.detectionCount;
            document.getElementById('lastDetection').textContent = new Date().toLocaleTimeString();
        }

        function showDetectionIndicator() {
            const overlay = document.getElementById('detectionOverlay');
            overlay.classList.add('active');
            setTimeout(() => {
                overlay.classList.remove('active');
            }, 1000);
        }

        function clearCanvas(canvasId) {
            const canvas = document.getElementById(canvasId);
            const ctx = canvas.getContext('2d');
            ctx.clearRect(0, 0, canvas.width, canvas.height);
        }

        // Initialize when page loads
        document.addEventListener('DOMContentLoaded', initializeApp);
    </script>
</body>

</html>