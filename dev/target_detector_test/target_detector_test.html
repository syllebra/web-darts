<!DOCTYPE html>
<html lang="fr">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>YoloTargetDetector JavaScript</title>
    <script src="../../ext/ort.min.js"></script>
    <style>
        body {
            transform: translate3d(0, 0, 0);
        }
    </style>
</head>

<body>
    <div id="demo">
        <h1>YoloTargetDetector JavaScript</h1>
        <input type="file" id="imageInput" accept="image/*">
        <canvas id="canvas" width="640" height="640"></canvas>
        <div id="results"></div>
    </div>

    <script src="../../ext/opencv.js"></script>
    <script>
        // Wait for OpenCV to load
        let cvLoaded = false;

        function onOpenCvReady() {
            cvLoaded = true;
            console.log('OpenCV.js is ready');
            //document.getElementById('results').innerHTML = 'OpenCV loaded - Ready to use!';
        }

        // Check if OpenCV is already loaded or wait for it
        if (typeof cv !== 'undefined') {
            onOpenCvReady();
        } else {
            window.addEventListener('load', () => {
                if (typeof cv !== 'undefined') {
                    onOpenCvReady();
                } else {
                    // Fallback check
                    const checkCV = setInterval(() => {
                        if (typeof cv !== 'undefined') {
                            clearInterval(checkCV);
                            onOpenCvReady();
                        }
                    }, 100);
                }
            });
        }
    </script>

    <script src="../../core/utils/ransac.js"></script>
    <script src="../../core/utils/icp.js"></script>
    
    <script src="../../core/Board.js"></script>
    <script src="../../core/TargetDetector.js"></script>

    <script>

        async function checkGPU() {
            if (!navigator.gpu) {
                throw Error("WebGPU not supported.");
            }

            const adapter = await navigator.gpu.requestAdapter();
            if (!adapter) {
                throw Error("Couldn't request WebGPU adapter.");
            }

            const device = await adapter.requestDevice();
            console.log("Device:",device)
        }
        checkGPU()

        const board = new Board();
        const detector = new YoloTargetDetector(board, modelPath = "../../models/best_n_tip_boxes_cross_640_B.onnx", autoAmCalib = false, initCallback = () => { load_and_detect_image("winmau_blade_6.jpg") });


        async function prepare_input(buf) {
            return new Promise(resolve => {
                const img = new Image();
                img.src = typeof (buf) == "string" ? buf : URL.createObjectURL(buf);
                img.onload = () => {
                    const [img_width, img_height] = [img.width, img.height]
                    const canvas = document.createElement("canvas");
                    canvas.width = 640;
                    canvas.height = 640;
                    const context = canvas.getContext("2d");
                    context.drawImage(img, 0, 0, 640, 640);
                    const imgData = context.getImageData(0, 0, 640, 640);
                    const pixels = imgData.data;

                    const red = [], green = [], blue = [];
                    for (let index = 0; index < pixels.length; index += 4) {
                        red.push(pixels[index] / 255.0);
                        green.push(pixels[index + 1] / 255.0);
                        blue.push(pixels[index + 2] / 255.0);
                    }
                    const input = [...red, ...green, ...blue];
                    resolve([input, img_width, img_height, imgData])
                }
            })
        }

        async function load_and_detect_image(file) {
            if (!file) return;


            const canvas = document.getElementById('canvas');
            const results = document.getElementById('results');

            prepared_input = await prepare_input(file)


            // Détection
            const result = await detector.detect(prepared_input[0], canvas,prepared_input[3]);

            // Afficher les résultats
            results.innerHTML = `
                    <h3>Résultats de détection:</h3>
                    <p>Points de calibration: ${result.calibrationPoints ? result.calibrationPoints.length : 0}</p>
                    <p>Confiance: ${result.confidence}</p>
                `;

            // Test des scores de fléchettes
            const testTips = [[150, 150], [200, 200]];
            const scores = detector.getDartScores(testTips, false);
            results.innerHTML += `<p>Scores test: ${scores.join(', ')}</p>`;
        }

        // Démonstration d'utilisation
        document.addEventListener('DOMContentLoaded', async () => {

            const imageInput = document.getElementById('imageInput');
            imageInput.addEventListener('change', async (event) => {
                load_and_detect_image(event.target.files[0]);
            });

            console.log("YoloTargetDetector JavaScript initialisé");
        });
    </script>
</body>

</html>app