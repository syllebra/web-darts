<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Darts Game Chooser</title>
    <link href="https://cdnjs.cloudflare.com/ajax/libs/bootstrap/5.3.0/css/bootstrap.min.css" rel="stylesheet">
    <link
        href="https://fonts.googleapis.com/css2?family=Orbitron:wght@400;700;900&family=Exo+2:wght@400;600;700;800;900&display=swap"
        rel="stylesheet">
    <link rel="stylesheet" href="ui/global.css">
    <link rel="stylesheet" href="ui/game_picker.css">
    <link rel="stylesheet" href="dev/slide_panel.css">
    <link rel="stylesheet" href="dev/modal_hot_loading/player/player_ui.css">
    <script src="../../core/Throw.js"></script>
    <script src="./dev/modal_hot_loading/paho-mqtt/1.0.1/mqttws31.min.js"></script>
</head>

<body>

    <div class="text-center container-fluid title-section-fixed" id="titleSection">
        <div class="title" id="title">
            <h1>Dart</h1>
            <h1>Net</h1>
        </div>
        <div class="subtitle">AI powered Darts game</div>
    </div>

    <div class="full-layer overlay-controls">
        <div class="back-btn position-fixed top-0 start-0 m-3 d-none align-items-center justify-content-center"
            id="backBtn" onclick="goBack()">‚Üê</div>
        <div class="fullscreen-btn position-fixed top-0 end-0 m-3 d-flex align-items-center justify-content-center"
            id="fullscreenBtn" onclick="toggleFullscreen()">‚õ∂</div>

        <div class="slidep-panel-container">
            <!-- Left Panel System -->
            <div class="slidep-panel-system slidep-left">
                <div class="slidep-toggle-group slidep-left slidep-visible">
                    <button class="slidep-panel-toggle slidep-left" onclick="togglePanel('navigation')">NAV</button>
                    <button class="slidep-panel-toggle slidep-left" onclick="togglePanel('info')">INFO</button>
                </div>

                <!-- Navigation Panel -->
                <div id="navigation" class="slidep-slice-panel slidep-left slidep-panel-small">
                    <div class="slidep-panel-header">
                        <h2 class="slidep-panel-title">
                            Navigation
                            <button class="slidep-close-btn" onclick="closePanel('navigation')">Close</button>
                        </h2>
                    </div>
                    <div class="slidep-panel-content">
                        <div class="slidep-panel-section">
                            <h3 class="slidep-section-title">Quick Links</h3>
                            <button class="slidep-control-button">Dashboard</button>
                            <button class="slidep-control-button">Projects</button>
                            <button class="slidep-control-button">Settings</button>
                            <button class="slidep-control-button">Help</button>
                            <button class="slidep-control-button">Profile</button>
                            <button class="slidep-control-button">Messages</button>
                        </div>
                        <div class="slidep-panel-section">
                            <h3 class="slidep-section-title">Recent Items</h3>
                            <div class="slidep-control-group">
                                <label class="slidep-control-label">Project A</label>
                                <input type="text" class="slidep-control-input" placeholder="Last modified 2 hours ago">
                            </div>
                            <div class="slidep-control-group">
                                <label class="slidep-control-label">Project B</label>
                                <input type="text" class="slidep-control-input" placeholder="Last modified 1 day ago">
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Info Panel -->
                <div id="info" class="slidep-slice-panel slidep-left slidep-panel-small">
                    <div class="slidep-panel-header">
                        <h2 class="slidep-panel-title">
                            Information
                            <button class="slidep-close-btn" onclick="closePanel('info')">Close</button>
                        </h2>
                    </div>
                    <div class="slidep-panel-content">
                        <div class="slidep-panel-section">
                            <h3 class="slidep-section-title">System Info</h3>
                            <p style="color: rgba(255,255,255,0.8); line-height: 1.6;">
                                <strong>Version:</strong> 2.0.0<br>
                                <strong>Build:</strong> 2024.12.30<br>
                                <strong>Panels Open:</strong> <span id="panelCount">0</span>
                            </p>
                        </div>
                        <div class="slidep-panel-section">
                            <h3 class="slidep-section-title">Features</h3>
                            <ul style="color: rgba(255,255,255,0.8); line-height: 1.8; list-style: none;">
                                <li>‚úì Simple class-based management</li>
                                <li>‚úì Left/right positioning</li>
                                <li>‚úì Panel stacking</li>
                                <li>‚úì Keyboard shortcuts</li>
                                <li>‚úì Responsive design</li>
                                <li>‚úì No DOM recreation</li>
                            </ul>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Right Panel System -->
            <div class="slidep-panel-system slidep-right">
                <div class="slidep-toggle-group slidep-right slidep-visible">
                    <button class="slidep-panel-toggle slidep-right" onclick="togglePanel('settings')">SET</button>
                    <button class="slidep-panel-toggle slidep-right" onclick="togglePanel('tools')">TOOL</button>
                </div>

                <!-- Settings Panel -->
                <div id="settings" class="slidep-slice-panel slidep-right slidep-panel-small">
                    <div class="slidep-panel-header">
                        <h2 class="slidep-panel-title">
                            Settings
                            <button class="slidep-close-btn" onclick="closePanel('settings')">Close</button>
                        </h2>
                    </div>
                    <div class="slidep-panel-content">
                        <div class="slidep-panel-section">
                            <h3 class="slidep-section-title">Display Settings</h3>
                            <div class="slidep-control-group">
                                <label class="slidep-control-label">Theme</label>
                                <select class="slidep-control-select">
                                    <option>Dark Mode</option>
                                    <option>Light Mode</option>
                                    <option>Auto</option>
                                </select>
                            </div>
                            <div class="slidep-control-group">
                                <label class="slidep-control-label">Font Size</label>
                                <select class="slidep-control-select">
                                    <option>Small</option>
                                    <option selected>Medium</option>
                                    <option>Large</option>
                                </select>
                            </div>
                            <div class="slidep-control-group">
                                <label class="slidep-control-checkbox">
                                    <input type="checkbox" checked>
                                    <span>Enable animations</span>
                                </label>
                            </div>
                        </div>
                        <div class="slidep-panel-section">
                            <h3 class="slidep-section-title">Panel Management</h3>
                            <button class="slidep-control-button slidep-primary" onclick="togglePanel('tools')">Open
                                Tools</button>
                            <button class="slidep-control-button" onclick="togglePanel('info')">Open Info</button>
                            <button class="slidep-control-button" onclick="closeAllPanels()">Close All</button>
                        </div>
                    </div>
                </div>

                <!-- Tools Panel -->
                <div id="tools" class="slidep-slice-panel slidep-right slidep-panel-small">
                    <div class="slidep-panel-header">
                        <h2 class="slidep-panel-title">
                            Tools
                            <button class="slidep-close-btn" onclick="closePanel('tools')">Close</button>
                        </h2>
                    </div>
                    <div class="slidep-panel-content">
                        <div class="slidep-panel-section">
                            <h3 class="slidep-section-title">Development Tools</h3>
                            <button class="slidep-control-button">Inspector</button>
                            <button class="slidep-control-button">Console</button>
                            <button class="slidep-control-button">Network</button>
                            <button class="slidep-control-button">Performance</button>
                        </div>
                        <div class="slidep-panel-section">
                            <h3 class="slidep-section-title">Utilities</h3>
                            <div class="slidep-control-group">
                                <label class="slidep-control-label">Color Picker</label>
                                <input type="color" class="slidep-control-input" value="#667eea">
                            </div>
                            <div class="slidep-control-group">
                                <label class="slidep-control-label">JSON Formatter</label>
                                <textarea class="slidep-control-input" rows="4"
                                    placeholder="Paste JSON here..."></textarea>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
    
    <div class="container-fluid d-flex flex-column justify-content-center align-items-center p-4 games-grid-container"
        id="gamePicker">
        <div class="games-grid" id="gamesGrid">
            <!-- Les cartes de jeux seront g√©n√©r√©es ici -->
        </div>
    </div>

    <!-- Game Details Modal -->
    <div class="modal fade" id="gameDetailsModal" tabindex="-1">
        <div class="modal-dialog modal-dialog-centered">
            <div class="modal-content details-content">
                <div class="modal-body text-center p-5">
                    <div id="modalPreGameSetup">
                        <h1 class="title" id="detailsTitle">‚ö° CYBER ARENA ‚ö°</h1>
                        <p class="details-description mb-4" id="detailsDescription">Description du jeu</p>

                        <div class="row g-3 mb-4" id="optionsGrid">
                            <!-- Options will be populated dynamically -->
                        </div>

                        <div class="floating-particles" id="particles"></div>

                        <div class="container">
                            <div class="header">
                                <div style="font-size: 0.8rem; opacity: 0.7;">Joueurs S√©lectionn√©s (<span id="selectedCount">0</span>/<span id="maxCount">6</span>)</div>
                            </div>

                            <div class="player-slots" id="playerSlots"></div>

                            <div class="available-players">
                                <div class="section-header">
                                    <h3 class="section-title">üöÄ Joueurs Disponibles</h3>
                                    <button class="create-btn" id="createBtn">
                                        <span style="margin-right: 5px;">üë§</span>Cr√©er
                                    </button>
                                </div>

                                <div id="createForm" class="create-form" style="display: none;">
                                    <div class="create-form-content">
                                        <input
                                                type="text"
                                                id="newPlayerName"
                                                class="create-input"
                                                placeholder="Nom du joueur..."
                                                maxlength="15"
                                        >
                                        <button class="create-submit" id="createSubmit">‚ú®</button>
                                    </div>
                                </div>

                                <div class="players-grid" id="playersGrid"></div>
                            </div>

                            <div class="options">
                                <div class="checkbox-container" id="randomOrderContainer">
                                    <div class="cyber-checkbox" id="randomOrderCheck">
                                        <span class="check">‚úì</span>
                                    </div>
                                    <label class="checkbox-label">
                                        <span style="font-size: 1.2rem;">üîÄ</span>
                                        Ordre al√©atoire
                                    </label>
                                </div>

                                <div class="checkbox-container" id="bullUpContainer">
                                    <div class="cyber-checkbox" id="bullUpCheck">
                                        <span class="check">‚úì</span>
                                    </div>
                                    <label class="checkbox-label">
                                        <span style="font-size: 1.2rem;">üéØ</span>
                                        Bull up ?
                                    </label>
                                </div>
                            </div>


                        </div>


                        <div id="warning" class="warning" style="display: none;">
                            ‚ö†Ô∏è Minimum <span id="minRequired">2</span> joueurs requis ‚ö†Ô∏è
                        </div>

                        <div class="d-flex gap-3 justify-content-center flex-wrap">
                            <button class="start-button btn btn-custom-primary px-4 py-2" onclick="startGame()" id="startButton" disabled>Start Game</button>
                            <button class="btn btn-custom-secondary px-4 py-2" onclick="goBack()">Back</button>
                        </div>
                    </div>
                    <div id="modalGameContainer" style="display: none;">
                        <!-- Le contenu du jeu sera charg√© ici -->
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Include all JavaScript files -->
    <script src="ui/global.js"></script>
    <script src="dev/slide_panel.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/bootstrap/5.3.0/js/bootstrap.bundle.min.js"></script>
    
    <!-- Remplacer les deux scripts par un seul fichier unifi√© -->
    <script src="./core/Game.js"></script>
    <script src="./dev/modal_hot_loading/player/player_ui.js"></script>
    <!-- Script MQTT et gestion des jeux -->
    <script>
        // Variables globales pour la gestion des jeux
        let currentGameId = null;
        let loadedStyles = [];
        let loadedScripts = [];

        // Variables MQTT
        let mqttClient = null;
        const mqttServer = 'localhost';
        const mqttPort = 8083;
        const mqttTopic = 'darts/results';
        const clientId = 'web_darts_client_' + Math.random().toString(16).substr(2, 8);
        window.activeGameReceiveMqttMessage = null;

        // --- FONCTIONS MQTT ---
        function connectMqtt() {
            if (mqttClient && mqttClient.isConnected()) {
                console.log("D√©j√† connect√© au serveur MQTT.");
                return;
            }

            // V√©rifier si Paho MQTT est disponible
            if (typeof Paho === 'undefined') {
                console.warn("Paho MQTT non disponible, connexion MQTT ignor√©e");
                return;
            }

            mqttClient = new Paho.MQTT.Client(mqttServer, mqttPort, "/mqtt", clientId);

            mqttClient.onConnectionLost = onConnectionLost;
            mqttClient.onMessageArrived = onMessageArrived;

            console.log(`Tentative de connexion √† MQTT : ${mqttServer}:${mqttPort}`);
            mqttClient.connect({
                onSuccess: onConnect,
                onFailure: onFailure,
                useSSL: false
            });
        }

        function onConnect() {
            console.log("Connect√© au serveur MQTT !");
            mqttClient.subscribe(mqttTopic, { qos: 0 });
            console.log(`Abonn√© au topic : ${mqttTopic}`);
        }

        function onFailure(responseObject) {
            console.error("√âchec de la connexion MQTT : " + responseObject.errorMessage);
        }

        function onConnectionLost(responseObject) {
            if (responseObject.errorCode !== 0) {
                console.log("Connexion MQTT perdue : " + responseObject.errorMessage);
            }
        }

        function onMessageArrived(message) {
            console.log(`Message MQTT re√ßu sur topic '${message.destinationName}' : ${message.payloadString}`);
            console.log(JSON.parse(message.payloadString))
            if (window.activeGameReceiveMqttMessage && typeof window.activeGameReceiveMqttMessage === 'function') {
                try {
                    console.log(JSON.parse(message.payloadString))
                    const dartResult = JSON.parse(message.payloadString);
                    window.activeGameReceiveMqttMessage(dartResult);
                } catch (e) {
                    console.error("Erreur lors du parsing du message MQTT ou de la transmission au jeu:", e);
                    window.activeGameReceiveMqttMessage(message.payloadString);
                }
            }
        }

        // Fonction de nettoyage des ressources
        function unloadGameResources() {
            console.log("unload game resources")
            if (window.currentActiveGameCleanup && typeof window.currentActiveGameCleanup === 'function') {
                window.currentActiveGameCleanup();
                window.currentActiveGameCleanup = null;
            }
            console.log(loadedStyles);
            loadedStyles.forEach(link => link.remove());
            loadedStyles = [];

            console.log(loadedScripts);
            loadedScripts.forEach(script => script.remove());
            loadedScripts = [];
            
            window.activeGameReceiveMqttMessage = null;
            console.log('Ressources du jeu d√©charg√©es !');
        }

        // Fonction pour fermer le modal de jeu
        window.closeGameModal = function() {
            alert("test")
            const gameDetailsModal = bootstrap.Modal.getInstance(document.getElementById('gameDetailsModal'));
            if (gameDetailsModal) {
                gameDetailsModal.hide();
            }
            unloadGameResources();
            const modalGameContainer = document.getElementById('gameDetailsModal');
            if (modalGameContainer) {
                modalGameContainer.innerHTML = `
    <div class="modal-dialog modal-dialog-centered">
        <div class="modal-content details-content">
            <div class="modal-body text-center p-5">
                    <div id="modalPreGameSetup">
                        <h1 class="title" id="detailsTitle">‚ö° CYBER ARENA ‚ö°</h1>
                        <p class="details-description mb-4" id="detailsDescription">Description du jeu</p>

                        <div class="row g-3 mb-4" id="optionsGrid">
                            <!-- Options will be populated dynamically -->
                        </div>

                        <div class="floating-particles" id="particles"></div>

                        <div class="container">
                            <div class="header">
                                <div style="font-size: 0.8rem; opacity: 0.7;">Joueurs S√©lectionn√©s (<span id="selectedCount">0</span>/<span id="maxCount">6</span>)</div>
                            </div>

                            <div class="player-slots" id="playerSlots"></div>

                            <div class="available-players">
                                <div class="section-header">
                                    <h3 class="section-title">üöÄ Joueurs Disponibles</h3>
                                    <button class="create-btn" id="createBtn">
                                        <span style="margin-right: 5px;">üë§</span>Cr√©er
                                    </button>
                                </div>

                                <div id="createForm" class="create-form" style="display: none;">
                                    <div class="create-form-content">
                                        <input
                                                type="text"
                                                id="newPlayerName"
                                                class="create-input"
                                                placeholder="Nom du joueur..."
                                                maxlength="15"
                                        >
                                        <button class="create-submit" id="createSubmit">‚ú®</button>
                                    </div>
                                </div>

                                <div class="players-grid" id="playersGrid"></div>
                            </div>

                            <div class="options">
                                <div class="checkbox-container" id="randomOrderContainer">
                                    <div class="cyber-checkbox" id="randomOrderCheck">
                                        <span class="check">‚úì</span>
                                    </div>
                                    <label class="checkbox-label">
                                        <span style="font-size: 1.2rem;">üîÄ</span>
                                        Ordre al√©atoire
                                    </label>
                                </div>

                                <div class="checkbox-container" id="bullUpContainer">
                                    <div class="cyber-checkbox" id="bullUpCheck">
                                        <span class="check">‚úì</span>
                                    </div>
                                    <label class="checkbox-label">
                                        <span style="font-size: 1.2rem;">üéØ</span>
                                        Bull up ?
                                    </label>
                                </div>
                            </div>


                        </div>


                        <div id="warning" class="warning" style="display: none;">
                            ‚ö†Ô∏è Minimum <span id="minRequired">2</span> joueurs requis ‚ö†Ô∏è
                        </div>

                        <div class="d-flex gap-3 justify-content-center flex-wrap">
                            <button class="start-button btn btn-custom-primary px-4 py-2" onclick="startGame()" id="startButton" disabled>Start Game</button>
                            <button class="btn btn-custom-secondary px-4 py-2" onclick="goBack()">Back</button>
                        </div>
                    </div>
                    <div id="modalGameContainer" style="display: none;">
                        <!-- Le contenu du jeu sera charg√© ici -->
                    </div>
            </div>
        </div>
    </div>
`;
            }
            currentGameId = null;
        };

        // // Fonction pour charger les ressources d'un jeu
        // async function loadGameResources(gameId) {
        //     if (currentGameId && currentGameId !== gameId) {
        //         unloadGameResources();
        //     }

        //     currentGameId = gameId;

        //     // Chargement du CSS
        //     const styleLink = document.createElement('link');
        //     styleLink.rel = 'stylesheet';
        //     styleLink.href = `games/${gameId}/game.css`;
        //     document.head.appendChild(styleLink);
        //     loadedStyles.push(styleLink);

        //     // Chargement des options pr√©-jeu si disponibles
        //     try {
        //         const response = await fetch(`games/${gameId}/pre_game_options.html`);
        //         if (response.ok) {
        //             const htmlContent = await response.text();
        //             // Traiter le contenu si n√©cessaire
        //             console.log(`Options pr√©-jeu charg√©es pour ${gameId}`);
        //         }
        //     } catch (error) {
        //         console.log(`Pas d'options pr√©-jeu pour ${gameId}:`, error);
        //     }
        // }

        // Initialisation au chargement de la page
        document.addEventListener('DOMContentLoaded', function() {
            // Connexion MQTT
            connectMqtt();
            
            // √âcouteur d'√©v√©nement personnalis√© pour le signal de fin de jeu
            document.addEventListener('gameEnded', (event) => {
                console.log("√âv√©nement 'gameEnded' re√ßu, fermeture de la modale.");
                window.closeGameModal();
            });
        });

        // Rendre les variables globales disponibles
        window.loadedStyles = loadedStyles;
        window.loadedScripts = loadedScripts;
    </script>
</body>

</html>